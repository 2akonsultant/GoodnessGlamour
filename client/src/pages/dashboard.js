import { jsx as _jsx, jsxs as _jsxs, Fragment as _Fragment } from "react/jsx-runtime";
import { useState, useEffect } from "react";
import { useLocation } from "wouter";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { useQuery } from "@tanstack/react-query";
import { Users, MessageSquare, DollarSign, TrendingUp, LogOut, Calendar, Lock } from "lucide-react";
import { PieChart, Pie, Cell, ResponsiveContainer, Legend, Tooltip, BarChart, Bar, XAxis, YAxis, CartesianGrid } from 'recharts';
const COLORS = ['#D4AF37', '#FFD700', '#F0E68C', '#BDB76B', '#DAA520'];
export default function Dashboard() {
    const [, setLocation] = useLocation();
    const [timeRange, setTimeRange] = useState("all");
    const [isAuthenticated, setIsAuthenticated] = useState(false);
    const [password, setPassword] = useState("");
    const [passwordError, setPasswordError] = useState("");
    // Check authentication - requires password every time
    useEffect(() => {
        const authStatus = sessionStorage.getItem("isAdminAuthenticated") === "true";
        setIsAuthenticated(authStatus);
    }, []);
    const handlePasswordSubmit = (e) => {
        e.preventDefault();
        if (password === "admin123") {
            sessionStorage.setItem("isAdminAuthenticated", "true");
            setIsAuthenticated(true);
            setPasswordError("");
        }
        else {
            setPasswordError("Incorrect password. Please try again.");
        }
    };
    const { data: stats, refetch: refetchStats } = useQuery({
        queryKey: ["/api/dashboard/stats", timeRange],
        queryFn: async () => {
            const response = await fetch(`/api/dashboard/stats?timeRange=${timeRange}`, {
                cache: 'no-cache',
                headers: { 'Cache-Control': 'no-cache' }
            });
            if (!response.ok)
                throw new Error('Failed to fetch stats');
            const data = await response.json();
            console.log('ðŸ“Š Stats received:', data);
            return data;
        },
        refetchInterval: 5000, // Auto-refresh every 5 seconds
        enabled: isAuthenticated, // Only fetch when authenticated
    });
    const { data: bookingsData, refetch: refetchBookings } = useQuery({
        queryKey: ["/api/dashboard/bookings", timeRange],
        queryFn: async () => {
            const response = await fetch(`/api/dashboard/bookings?timeRange=${timeRange}`, {
                cache: 'no-cache',
                headers: { 'Cache-Control': 'no-cache' }
            });
            if (!response.ok)
                throw new Error('Failed to fetch bookings');
            const data = await response.json();
            console.log('ðŸ“… Bookings received:', data);
            return data;
        },
        refetchInterval: 5000, // Auto-refresh every 5 seconds
        enabled: isAuthenticated, // Only fetch when authenticated
    });
    const { data: messages, refetch: refetchMessages } = useQuery({
        queryKey: ["/api/dashboard/messages", timeRange],
        queryFn: async () => {
            const response = await fetch(`/api/dashboard/messages?timeRange=${timeRange}`, {
                cache: 'no-cache',
                headers: { 'Cache-Control': 'no-cache' }
            });
            if (!response.ok)
                throw new Error('Failed to fetch messages');
            const data = await response.json();
            console.log('ðŸ“§ Messages received:', data.length, data);
            console.log('ðŸ“‹ First 3 messages:', data.slice(0, 3));
            console.log('ðŸ“… All dates:', data.map((m) => m['Submission Date']));
            return data;
        },
        refetchInterval: 5000, // Auto-refresh every 5 seconds
        enabled: isAuthenticated, // Only fetch when authenticated
    });
    const handleLogout = () => {
        sessionStorage.removeItem("isAdminAuthenticated");
        setLocation("/login");
    };
    // Show password prompt if not authenticated
    if (!isAuthenticated) {
        return (_jsxs("div", { className: "min-h-screen flex items-center justify-center bg-gradient-to-br from-gray-900 via-black to-gray-800 p-4 relative overflow-hidden", children: [_jsxs("div", { className: "absolute inset-0", children: [_jsx("div", { className: "absolute top-20 left-20 w-96 h-96 bg-gradient-to-r from-amber-500/10 to-rose-500/10 rounded-full blur-3xl" }), _jsx("div", { className: "absolute top-40 right-32 w-80 h-80 bg-gradient-to-r from-purple-500/10 to-pink-500/10 rounded-full blur-3xl" }), _jsx("div", { className: "absolute bottom-32 left-32 w-72 h-72 bg-gradient-to-r from-rose-500/10 to-amber-500/10 rounded-full blur-3xl" }), _jsx("div", { className: "absolute bottom-20 right-20 w-64 h-64 bg-gradient-to-r from-amber-500/10 to-rose-500/10 rounded-full blur-3xl" })] }), _jsxs(Card, { className: "w-full max-w-md bg-gray-900/90 backdrop-blur-xl border border-gray-700/50 shadow-2xl shadow-black/50 relative z-10", children: [_jsxs(CardHeader, { className: "text-center pb-8", children: [_jsx("div", { className: "mx-auto mb-6 w-20 h-20 bg-gradient-to-br from-amber-400 via-rose-400 to-purple-500 rounded-full flex items-center justify-center shadow-lg shadow-amber-500/25", children: _jsx(Lock, { className: "h-10 w-10 text-white" }) }), _jsx(CardTitle, { className: "text-4xl font-serif text-white bg-gradient-to-r from-amber-200 via-rose-200 to-purple-200 bg-clip-text text-transparent", children: "Admin Access" }), _jsx(CardDescription, { className: "text-gray-300 font-medium text-lg", children: "Enter password to access dashboard" })] }), _jsx(CardContent, { children: _jsxs("form", { onSubmit: handlePasswordSubmit, className: "space-y-4", children: [passwordError && (_jsx("div", { className: "text-red-400 text-sm text-center bg-red-900/20 border border-red-500/30 rounded-lg p-3", children: passwordError })), _jsxs("div", { className: "space-y-3", children: [_jsx(Label, { htmlFor: "password", className: "text-gray-200 font-medium text-sm uppercase tracking-wider", children: "Password" }), _jsx(Input, { id: "password", type: "password", placeholder: "Enter admin password", value: password, onChange: (e) => setPassword(e.target.value), className: "border-gray-600 focus:border-amber-400 focus:ring-amber-400/20 bg-gray-800/50 backdrop-blur-sm text-white placeholder:text-gray-400 h-12", required: true })] }), _jsx(Button, { type: "submit", className: "w-full bg-gradient-to-r from-amber-500 via-rose-500 to-purple-600 hover:from-amber-600 hover:via-rose-600 hover:to-purple-700 text-white font-semibold py-4 rounded-lg shadow-2xl shadow-amber-500/25 transition-all duration-300 transform hover:scale-[1.02] uppercase tracking-wider", children: "Access Dashboard" })] }) })] })] }));
    }
    return (_jsx("div", { className: "min-h-screen pt-20 px-4 pb-12 gradient-hero", children: _jsxs("div", { className: "max-w-7xl mx-auto space-y-8", children: [_jsxs("div", { className: "flex items-center justify-between", children: [_jsxs("div", { children: [_jsx("h1", { className: "text-4xl font-serif font-bold text-foreground mb-2", children: "Dashboard" }), _jsx("p", { className: "text-muted-foreground", children: "Monitor your salon's performance and customer activity" })] }), _jsxs("div", { className: "flex items-center gap-4", children: [_jsx(Button, { onClick: () => {
                                        refetchStats();
                                        refetchBookings();
                                        refetchMessages();
                                    }, variant: "outline", size: "sm", children: "\uD83D\uDD04 Refresh" }), _jsxs(Select, { value: timeRange, onValueChange: setTimeRange, children: [_jsx(SelectTrigger, { className: "w-[180px]", children: _jsx(SelectValue, { placeholder: "Select time range" }) }), _jsxs(SelectContent, { children: [_jsx(SelectItem, { value: "today", children: "Today" }), _jsx(SelectItem, { value: "week", children: "This Week" }), _jsx(SelectItem, { value: "month", children: "This Month" }), _jsx(SelectItem, { value: "all", children: "All Time" })] })] }), _jsxs(Button, { variant: "outline", onClick: handleLogout, className: "flex items-center gap-2", children: [_jsx(LogOut, { className: "h-4 w-4" }), "Logout"] })] })] }), _jsxs("div", { className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6", children: [_jsxs(Card, { className: "bg-card/80 backdrop-blur-sm", children: [_jsxs(CardHeader, { className: "flex flex-row items-center justify-between space-y-0 pb-2", children: [_jsx(CardTitle, { className: "text-sm font-medium", children: "Total Bookings" }), _jsx(Users, { className: "h-4 w-4 text-primary" })] }), _jsxs(CardContent, { children: [_jsx("div", { className: "text-3xl font-bold text-primary", children: stats?.totalBookings || 0 }), _jsx("p", { className: "text-xs text-muted-foreground mt-1", children: "Confirmed appointments" })] })] }), _jsxs(Card, { className: "bg-card/80 backdrop-blur-sm", children: [_jsxs(CardHeader, { className: "flex flex-row items-center justify-between space-y-0 pb-2", children: [_jsx(CardTitle, { className: "text-sm font-medium", children: "Messages" }), _jsx(MessageSquare, { className: "h-4 w-4 text-accent" })] }), _jsxs(CardContent, { children: [_jsx("div", { className: "text-3xl font-bold text-accent", children: stats?.totalMessages || 0 }), _jsx("p", { className: "text-xs text-muted-foreground mt-1", children: "Customer inquiries" })] })] }), _jsxs(Card, { className: "bg-card/80 backdrop-blur-sm", children: [_jsxs(CardHeader, { className: "flex flex-row items-center justify-between space-y-0 pb-2", children: [_jsx(CardTitle, { className: "text-sm font-medium", children: "Total Revenue" }), _jsx(DollarSign, { className: "h-4 w-4 text-primary" })] }), _jsxs(CardContent, { children: [_jsxs("div", { className: "text-3xl font-bold text-primary", children: ["\u20B9", stats?.totalRevenue || 0] }), _jsx("p", { className: "text-xs text-muted-foreground mt-1", children: "From all bookings" })] })] }), _jsxs(Card, { className: "bg-card/80 backdrop-blur-sm", children: [_jsxs(CardHeader, { className: "flex flex-row items-center justify-between space-y-0 pb-2", children: [_jsx(CardTitle, { className: "text-sm font-medium", children: "Avg Booking Value" }), _jsx(TrendingUp, { className: "h-4 w-4 text-accent" })] }), _jsxs(CardContent, { children: [_jsxs("div", { className: "text-3xl font-bold text-accent", children: ["\u20B9", stats?.averageBookingValue || 0] }), _jsx("p", { className: "text-xs text-muted-foreground mt-1", children: "Per appointment" })] })] })] }), _jsxs("div", { className: "grid grid-cols-1 lg:grid-cols-2 gap-6", children: [_jsxs(Card, { className: "bg-card/80 backdrop-blur-sm", children: [_jsx(CardHeader, { children: _jsx(CardTitle, { className: "font-serif", children: "Popular Services" }) }), _jsx(CardContent, { children: stats?.popularServices && stats.popularServices.length > 0 ? (_jsx(ResponsiveContainer, { width: "100%", height: 300, children: _jsxs(PieChart, { children: [_jsx(Pie, { data: stats.popularServices, cx: "50%", cy: "50%", labelLine: false, label: ({ name, percent }) => `${name}: ${(percent * 100).toFixed(0)}%`, outerRadius: 80, fill: "#8884d8", dataKey: "value", children: stats.popularServices.map((entry, index) => (_jsx(Cell, { fill: COLORS[index % COLORS.length] }, `cell-${index}`))) }), _jsx(Tooltip, {}), _jsx(Legend, {})] }) })) : (_jsx("div", { className: "h-[300px] flex items-center justify-center text-muted-foreground", children: "No service data available" })) })] }), _jsxs(Card, { className: "bg-card/80 backdrop-blur-sm", children: [_jsx(CardHeader, { children: _jsx(CardTitle, { className: "font-serif", children: "Booking Trends" }) }), _jsx(CardContent, { children: bookingsData?.trends && bookingsData.trends.length > 0 ? (_jsx(ResponsiveContainer, { width: "100%", height: 300, children: _jsxs(BarChart, { data: bookingsData.trends, children: [_jsx(CartesianGrid, { strokeDasharray: "3 3" }), _jsx(XAxis, { dataKey: "date" }), _jsx(YAxis, {}), _jsx(Tooltip, {}), _jsx(Legend, {}), _jsx(Bar, { dataKey: "bookings", fill: "#D4AF37", name: "Bookings" }), _jsx(Bar, { dataKey: "revenue", fill: "#FFD700", name: "Revenue (\u20B9)" })] }) })) : (_jsx("div", { className: "h-[300px] flex items-center justify-center text-muted-foreground", children: "No booking trends available" })) })] })] }), _jsxs("div", { className: "grid grid-cols-1 lg:grid-cols-2 gap-6", children: [_jsxs(Card, { className: "bg-card/80 backdrop-blur-sm", children: [_jsx(CardHeader, { children: _jsx(CardTitle, { className: "font-serif", children: "Recent Bookings" }) }), _jsx(CardContent, { children: _jsx("div", { className: "space-y-4", children: bookingsData?.bookings && bookingsData.bookings.length > 0 ? (bookingsData.bookings.slice(0, 5).map((booking, index) => (_jsxs("div", { className: "flex items-center justify-between p-3 bg-secondary/20 rounded-lg", children: [_jsxs("div", { className: "flex-1", children: [_jsx("p", { className: "font-medium text-foreground", children: booking.Name }), _jsx("p", { className: "text-sm text-muted-foreground", children: booking.Services })] }), _jsxs("div", { className: "text-right", children: [_jsxs("p", { className: "font-semibold text-primary", children: ["\u20B9", booking['Total Amount']] }), _jsx("p", { className: "text-xs text-muted-foreground", children: booking.Date })] })] }, index)))) : (_jsx("p", { className: "text-center text-muted-foreground py-8", children: "No bookings yet" })) }) })] }), _jsxs(Card, { className: "bg-card/80 backdrop-blur-sm", children: [_jsx(CardHeader, { children: _jsx(CardTitle, { className: "font-serif", children: "Recent Messages" }) }), _jsx(CardContent, { children: _jsx("div", { className: "space-y-4", children: messages && Array.isArray(messages) && messages.length > 0 ? (messages.slice(0, 5).map((message, index) => (_jsxs("div", { className: "p-3 bg-secondary/20 rounded-lg", children: [_jsxs("div", { className: "flex items-center justify-between mb-2", children: [_jsx("p", { className: "font-medium text-foreground", children: message.Name || 'Unknown' }), _jsx("p", { className: "text-xs text-muted-foreground", children: message['Phone Number'] || 'No phone' })] }), _jsx("p", { className: "text-sm text-muted-foreground", children: message['Service Interest'] || 'No service' }), _jsx("p", { className: "text-xs text-muted-foreground mt-1", children: message.Address || 'No address' }), message.Message && (_jsxs("p", { className: "text-xs text-muted-foreground mt-2 italic", children: ["\"", message.Message, "\""] })), _jsx("p", { className: "text-xs text-muted-foreground mt-2", children: message['Submission Date'] || 'No date' })] }, index)))) : (_jsx("p", { className: "text-center text-muted-foreground py-8", children: "No messages yet. Submit a contact form to see data here." })) }) })] })] }), _jsxs(Card, { className: "bg-card/80 backdrop-blur-sm", children: [_jsx(CardHeader, { children: _jsxs(CardTitle, { className: "font-serif flex items-center gap-2", children: [_jsx(MessageSquare, { className: "h-5 w-5" }), "All Contact Messages (", messages?.length || 0, ")"] }) }), _jsx(CardContent, { children: _jsx("div", { className: "space-y-3 max-h-96 overflow-y-auto", children: messages && messages.length > 0 ? (messages.map((message, index) => (_jsx("div", { className: "p-4 bg-secondary/20 rounded-lg border border-border/50", children: _jsxs("div", { className: "grid grid-cols-1 md:grid-cols-6 gap-4 items-start", children: [_jsx("div", { className: "md:col-span-2", children: _jsxs("div", { className: "flex items-center gap-2 mb-2", children: [_jsx("div", { className: "w-8 h-8 bg-primary/20 rounded-full flex items-center justify-center", children: _jsx("span", { className: "text-sm font-medium text-primary", children: message.Name?.charAt(0) || '?' }) }), _jsxs("div", { children: [_jsx("p", { className: "font-medium text-foreground", children: message.Name || 'Unknown' }), _jsx("p", { className: "text-xs text-muted-foreground", children: message['Phone Number'] || 'No phone' })] })] }) }), _jsxs("div", { className: "md:col-span-2", children: [_jsx("p", { className: "text-sm font-medium text-foreground mb-1", children: "Service Interest" }), _jsx("p", { className: "text-sm text-muted-foreground", children: message['Service Interest'] || 'No service' }), message.Message && (_jsxs(_Fragment, { children: [_jsx("p", { className: "text-sm font-medium text-foreground mt-2 mb-1", children: "Message" }), _jsxs("p", { className: "text-sm text-muted-foreground italic", children: ["\"", message.Message, "\""] })] }))] }), _jsxs("div", { className: "md:col-span-2", children: [_jsx("p", { className: "text-sm font-medium text-foreground mb-1", children: "Address" }), _jsx("p", { className: "text-sm text-muted-foreground", children: message.Address || 'No address' }), _jsx("p", { className: "text-xs text-muted-foreground mt-2", children: message['Submission Date'] || 'No date' })] })] }) }, index)))) : (_jsx("p", { className: "text-center text-muted-foreground py-8", children: "No messages found for the selected time period." })) }) })] }), _jsxs(Card, { className: "bg-card/80 backdrop-blur-sm", children: [_jsx(CardHeader, { children: _jsxs(CardTitle, { className: "font-serif flex items-center gap-2", children: [_jsx(Calendar, { className: "h-5 w-5" }), "All Bookings (", bookingsData?.bookings?.length || 0, ")"] }) }), _jsx(CardContent, { children: _jsx("div", { className: "space-y-3 max-h-96 overflow-y-auto", children: bookingsData?.bookings && bookingsData.bookings.length > 0 ? (bookingsData.bookings.map((booking, index) => (_jsx("div", { className: "p-4 bg-secondary/20 rounded-lg border border-border/50", children: _jsxs("div", { className: "grid grid-cols-1 md:grid-cols-6 gap-4 items-start", children: [_jsx("div", { className: "md:col-span-2", children: _jsxs("div", { className: "flex items-center gap-2 mb-2", children: [_jsx("div", { className: "w-8 h-8 bg-accent/20 rounded-full flex items-center justify-center", children: _jsx("span", { className: "text-sm font-medium text-accent", children: booking.Name?.charAt(0) || '?' }) }), _jsxs("div", { children: [_jsx("p", { className: "font-medium text-foreground", children: booking.Name || 'Unknown' }), _jsx("p", { className: "text-xs text-muted-foreground", children: booking['Phone Number'] || 'No phone' })] })] }) }), _jsxs("div", { className: "md:col-span-2", children: [_jsx("p", { className: "text-sm font-medium text-foreground mb-1", children: "Services" }), _jsx("p", { className: "text-sm text-muted-foreground", children: booking.Services || 'No services' }), booking.Notes && (_jsxs(_Fragment, { children: [_jsx("p", { className: "text-sm font-medium text-foreground mt-2 mb-1", children: "Notes" }), _jsxs("p", { className: "text-sm text-muted-foreground italic", children: ["\"", booking.Notes, "\""] })] }))] }), _jsxs("div", { className: "md:col-span-2", children: [_jsx("p", { className: "text-sm font-medium text-foreground mb-1", children: "Appointment" }), _jsx("p", { className: "text-sm text-muted-foreground", children: booking.Date || 'No date' }), _jsxs("p", { className: "text-sm font-medium text-primary mt-1", children: ["\u20B9", booking['Total Amount'] || '0'] }), _jsx("p", { className: "text-xs text-muted-foreground mt-1", children: booking.Location || 'No location' })] })] }) }, index)))) : (_jsx("p", { className: "text-center text-muted-foreground py-8", children: "No bookings found for the selected time period." })) }) })] })] }) }));
}
